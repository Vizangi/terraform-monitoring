## В Terraform файлы **`variables.tf`** и **`terraform.tfvars`**

Используются для определения и задания значений переменных, которые позволяют параметризовать конфигурации инфраструктуры. Они работают вместе, чтобы обеспечить гибкость и повторное использование кода, особенно в сценариях, таких как управление инфраструктурой для сред разработки, тестирования и продакшена. Давайте разберём, как они взаимодействуют, их назначение и как они применяются с Terraform и Docker.

---

### Назначение каждого файла

1. **`variables.tf`**:
   - **Что это**: Файл, в котором **объявляются переменные** (их имена, типы, описания и, при необходимости, значения по умолчанию).
   - **Цель**: Определяет структуру переменных, которые будут использоваться в Terraform-конфигурациях. Это как "контракт", указывающий, какие переменные ожидаются и как они должны выглядеть.
   - **Содержимое**: Определения переменных с помощью ключевого слова `variable`. Например, имя переменной, тип (`string`, `number`, `map`, и т.д.), описание и необязательное значение по умолчанию.
   - **Пример использования**: Указывает, что для настройки сред (dev, staging, prod) нужны переменные, такие как `env_name`, `web_port`, `db_user`.

2. **`terraform.tfvars`**:
   - **Что это**: Файл, в котором **задаются конкретные значения** для переменных, объявленных в `variables.tf`.
   - **Цель**: Предоставляет фактические данные для переменных, чтобы Terraform мог использовать их при применении конфигурации. Это как "заполнение формы", где переменные из `variables.tf` получают значения.
   - **Содержимое**: Пары ключ-значение, где ключи соответствуют именам переменных из `variables.tf`.
   - **Пример использования**: Указывает, что для среды `dev` порт веб-сервера равен `8080`, а для `prod` — `8082`.

---

### Как они работают вместе?

1. **Объявление переменных (`variables.tf`)**:
   - В `variables.tf` вы определяете переменные, которые Terraform будет использовать. Например, вы указываете, что есть переменная `web_port` типа `number` с описанием и, возможно, значением по умолчанию.
   - Terraform использует эти объявления для проверки типов и обеспечения того, что все необходимые переменные будут предоставлены.

2. **Задание значений (`terraform.tfvars`)**:
   - В `terraform.tfvars` вы задаёте конкретные значения для переменных, объявленных в `variables.tf`. Например, `web_port = 8080`.
   - Terraform автоматически подгружает файл `terraform.tfvars` (если он существует) при выполнении команд `terraform plan` или `terraform apply`.

3. **Связь**:
   - Переменные из `variables.tf` — это шаблон, который говорит Terraform, какие данные нужны.
   - Значения из `terraform.tfvars` — это данные, которые "заполняют" этот шаблон.
   - Если в `terraform.tfvars` не указано значение для переменной, Terraform:
     - Использует значение по умолчанию из `variables.tf` (если оно есть).
     - Запрашивает значение у пользователя (если нет значения по умолчанию и переменная обязательна).
     - Выдаёт ошибку, если значение не предоставлено и нет значения по умолчанию.

4. **Использование в коде**:
   - В Terraform-конфигурациях (например, в `main.tf`, `dev.tf`) вы ссылаетесь на переменные с помощью синтаксиса `var.<имя_переменной>` (например, `var.web_port`).
   - Terraform подставляет значения из `terraform.tfvars` (или других источников, таких как CLI или файлы `*.tfvars`) в эти ссылки.

---

### Пример в контексте вашего проекта

В вашем учебном проекте вы создаёте инфраструктуру для сред **dev**, **staging** и **prod** с помощью Terraform и Docker. Переменные используются для настройки портов, пользователей баз данных и других параметров, чтобы обеспечить консистентность сред. Вот как `variables.tf` и `terraform.tfvars` работают вместе.

#### Пример `variables.tf`
```hcl
variable "environments" {
  description = "Map of environment configurations"
  type = map(object({
    web_port    = number
    db_user     = string
    db_password = string
  }))
  default = {
    dev = {
      web_port    = 8080
      db_user     = "dev_user"
      db_password = "dev_password"
    }
    staging = {
      web_port    = 8081
      db_user     = "staging_user"
      db_password = "staging_password"
    }
    prod = {
      web_port    = 8082
      db_user     = "prod_user"
      db_password = "prod_password"
    }
  }
}
```

- **Что делает**:
  - Объявляет переменную `environments` типа `map(object)`, которая содержит конфигурации для каждой среды.
  - Каждая среда имеет три поля: `web_port` (порт веб-сервера), `db_user` (пользователь базы данных), `db_password` (пароль базы данных).
  - Указывает значения по умолчанию, которые будут использованы, если `terraform.tfvars` не предоставит свои значения.

#### Пример `terraform.tfvars`
```hcl
environments = {
  dev = {
    web_port    = 8080
    db_user     = "dev_user"
    db_password = "dev_password"
  }
  staging = {
    web_port    = 8081
    db_user     = "staging_user"
    db_password = "staging_password"
  }
  prod = {
    web_port    = 8082
    db_user     = "prod_user"
    db_password = "prod_password"
  }
}
```

- **Что делает**:
  - Задаёт конкретные значения для переменной `environments`, переопределяя значения по умолчанию из `variables.tf` (в данном случае они совпадают, но могут быть другими).
  - Terraform автоматически подгружает этот файл и использует указанные значения.

#### Использование в конфигурации
В файлах `dev.tf`, `staging.tf`, `prod.tf` вы вызываете модуль, ссылаясь на переменные:

##### `dev.tf`
```hcl
module "dev" {
  source      = "./modules/environment"
  env_name    = "dev"
  web_port    = var.environments["dev"].web_port
  db_user     = var.environments["dev"].db_user
  db_password = var.environments["dev"].db_password
}
```

- **Как работает**:
  - Terraform берёт значения `web_port`, `db_user`, `db_password` для среды `dev` из `var.environments["dev"]`.
  - Значения подставляются из `terraform.tfvars` (или из значения по умолчанию в `variables.tf`, если `terraform.tfvars` отсутствует).

---

### Как Terraform обрабатывает эти файлы?

1. **Загрузка `variables.tf`**:
   - Terraform читает `variables.tf` при инициализации (`terraform init`) и регистрирует все объявленные переменные.
   - Проверяет, что все переменные имеют правильный тип и, если есть значения по умолчанию, сохраняет их.

2. **Загрузка `terraform.tfvars`**:
   - При выполнении `terraform plan` или `terraform apply` Terraform автоматически ищет файл `terraform.tfvars` в текущей директории.
   - Если файл найден, Terraform сопоставляет значения из `terraform.tfvars` с переменными из `variables.tf`.
   - Если в `terraform.tfvars` указаны значения для переменных, они имеют приоритет над значениями по умолчанию из `variables.tf`.

3. **Другие способы задания значений**:
   - Вы можете использовать другие файлы `*.tfvars` (например, `prod.tfvars`), указав их явно: `terraform apply -var-file=prod.tfvars`.
   - Значения можно передать через командную строку: `terraform apply -var="environments.dev.web_port=8080"`.
   - Terraform также проверяет переменные окружения (например, `TF_VAR_environments`) для значений.

4. **Проверка обязательности**:
   - Если переменная в `variables.tf` не имеет значения по умолчанию и не указана в `terraform.tfvars` (или других источниках), Terraform выдаст ошибку или запросит значение у пользователя.

---

### Пример взаимодействия в вашем проекте

Предположим, вы хотите изменить порт для среды `staging` на `8090` вместо `8081`. Вот как это работает:

1. **Объявление в `variables.tf`**:
   - Переменная `environments` уже объявлена с полем `web_port` для каждой среды.
   - Значение по умолчанию для `staging.web_port` равно `8081`.

2. **Изменение в `terraform.tfvars`**:
   ```hcl
   environments = {
     dev = {
       web_port    = 8080
       db_user     = "dev_user"
       db_password = "dev_password"
     }
     staging = {
       web_port    = 8090  # Изменено с 8081 на 8090
       db_user     = "staging_user"
       db_password = "staging_password"
     }
     prod = {
       web_port    = 8082
       db_user     = "prod_user"
       db_password = "prod_password"
     }
   }
   ```

3. **Применение**:
   - Terraform подгрузит `terraform.tfvars` и использует `web_port = 8090` для модуля `staging`.
   - В результате контейнер `staging-web` будет доступен на порту `8090` вместо `8081`.

4. **Проверка**:
   - Выполните `terraform apply` и проверьте, что Nginx для staging доступен по адресу `http://localhost:8090`.

---

### Лучшие практики

1. **Используйте значения по умолчанию**:
   - В `variables.tf` задавайте разумные значения по умолчанию для необязательных переменных, чтобы уменьшить необходимость в `terraform.tfvars`.
   - Например, в вашем проекте значения по умолчанию для `environments` позволяют запустить конфигурацию без `terraform.tfvars`.

2. **Разделяйте `*.tfvars` для разных сред**:
   - Вместо одного `terraform.tfvars` можно создать отдельные файлы, например:
     - `dev.tfvars`
     - `staging.tfvars`
     - `prod.tfvars`
   - Применяйте их с помощью `terraform apply -var-file=dev.tfvars`.

3. **Защищайте чувствительные данные**:
   - В вашем примере `db_password` хранится в `terraform.tfvars`. В реальных проектах избегайте хранения паролей в открытом виде.
   - Используйте инструменты вроде HashiCorp Vault или переменные окружения для чувствительных данных.

4. **Документируйте переменные**:
   - В `variables.tf` используйте поле `description` для объяснения назначения каждой переменной. Это помогает студентам понять, что они настраивают.

5. **Минимизируйте дублирование**:
   - В вашем проекте переменная `environments` типа `map` позволяет хранить все конфигурации сред в одном месте, что упрощает управление.

---

### Применение к вашему учебному курсу

В контексте вашего курса по Terraform и Ansible с использованием Docker:
- **`variables.tf`** определяет структуру конфигураций для сред (dev, staging, prod), включая порты, пользователей и пароли. Это помогает студентам понять, как параметризовать инфраструктуру.
- **`terraform.tfvars`** позволяет экспериментировать с разными значениями (например, менять порты или имена баз данных) без изменения основного кода.
- **Задания для студентов**:
  - Изменить порт в `terraform.tfvars` для одной из сред и проверить результат.
  - Добавить новую среду (например, `test`) в `terraform.tfvars` и создать для неё конфигурацию.
  - Удалить значение переменной из `terraform.tfvars` и посмотреть, как Terraform использует значение по умолчанию.

---

