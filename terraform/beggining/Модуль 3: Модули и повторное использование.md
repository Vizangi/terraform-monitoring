# Модуль 3: Модули и повторное использование

## **Что такое модули в Terraform?**

Модуль в Terraform — это контейнер для ресурсов, который позволяет организовать и повторно использовать конфигурации. Модули могут быть:

* **Локальными** — хранятся в той же директории, что и основной код.
* **Удалёнными** — размещаются в Terraform Registry или других репозиториях.

Модуль состоит из:

* **main.tf** — определяет ресурсы.
* **variables.tf** — описывает входные переменные.
* **outputs.tf** — определяет выходные значения.

**Зачем использовать модули?**

Использование модулей предоставляет следующие преимущества:

* **Повторное использование**: один раз написав модуль, его можно использовать в различных проектах и окружениях.
* **Читаемость и поддерживаемость**: разделение кода на модули упрощает его понимание и поддержку.
* **Изоляция изменений**: изменения в модуле не влияют на другие части инфраструктуры, если интерфейс модуля остаётся неизменным.
* **Тестируемость**: модули можно тестировать независимо от основной инфраструктуры.

**Принципы проектирования модулей**

При создании модулей следует придерживаться следующих принципов:

* **Принцип единой ответственности**: каждый модуль должен выполнять одну задачу.
* **Параметризация**: использовать переменные для настройки поведения модуля.
* **Документирование**: каждый модуль должен содержать файл `README.md`, описывающий его назначение, входные и выходные параметры.
* **Версионирование**: при изменении модуля следует увеличивать его версию, чтобы пользователи могли отслеживать изменения и обновления.

**Структура проекта с модулями**

Рекомендуемая структура проекта с использованием модулей:

```
.
├── modules/
│   ├── nginx/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── README.md
│   └── prometheus/
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── README.md
├── environments/
│   ├── dev/
│   │   ├── main.tf
│   │   └── terraform.tfvars
│   └── prod/
│       ├── main.tf
│       └── terraform.tfvars
└── main.tf
```

В этой структуре:

* **modules/** — директория, содержащая все модули.
* **environments/** — директория, содержащая конфигурации для различных окружений.
* **main.tf** — основной файл конфигурации, использующий модули.

**Использование модулей в конфигурации**

Для использования модуля в конфигурации необходимо добавить блок `module`:

```hcl
module "nginx" {
  source = "./modules/nginx"
  container_name = "nginx-container"
}
```

В этом примере:

* `source` указывает путь к модулю.
* `container_name` — входная переменная модуля, задающая имя контейнера.

**Входные и выходные переменные**

Модули используют переменные для настройки своего поведения:

* **Входные переменные** определяются в файле `variables.tf` и позволяют пользователю модуля настраивать его параметры.
* **Выходные переменные** определяются в файле `outputs.tf` и позволяют модулю передавать информацию обратно в основную конфигурацию.

Пример входной переменной:

```hcl
variable "container_name" {
  description = "Имя контейнера"
  type        = string
  default     = "nginx-container"
}
```

Пример выходной переменной:

```hcl
output "container_name" {
  value = docker_container.nginx.name
}
```

**Локальные модули**

Локальные модули хранятся в той же директории, что и основная конфигурация. Они полезны для небольших проектов или для тестирования модулей перед их публикацией.

Пример использования локального модуля:

```hcl
module "nginx" {
  source = "./modules/nginx"
}
```

**Публикация модулей**

Если модуль может быть полезен другим пользователям, его можно опубликовать в [Terraform Registry](https://registry.terraform.io/). Для этого необходимо:

1. Создать репозиторий с кодом модуля.
2. Добавить файл `README.md` с описанием модуля.
3. Опубликовать модуль в Terraform Registry.

**Версионирование модулей**

При изменении модуля следует увеличивать его версию, чтобы пользователи могли отслеживать изменения и обновления. Рекомендуется использовать [семантическое версионирование](https://semver.org/).
