# Модуль 5: Интеграция с мониторингом и алёртами

## **Цель модуля**

Научиться интегрировать Terraform с решениями для мониторинга и алёртинга, а также настроить автоматические уведомления и оповещения при изменениях инфраструктуры. Мы рассмотрим, как можно использовать Terraform для настройки мониторинга в облачных и локальных решениях, а также настройку оповещений и алёртов для отслеживания состояния ресурсов.

### 1. **Зачем интегрировать Terraform с мониторингом и алёртами?**

Интеграция Terraform с системами мониторинга и алёртами важна для обеспечения стабильности, надежности и оперативности в управлении инфраструктурой. Вот несколько причин, почему это важно:

* **Прогнозируемость и контроль**: Мониторинг позволяет отслеживать изменения в инфраструктуре и предупреждать о возможных проблемах до их возникновения.
* **Автоматизация и оперативность**: С помощью алёртов и уведомлений можно оперативно реагировать на ошибки или отклонения от нормы, автоматически предпринимая действия для исправления.
* **Устранение сбоев и деградации**: Настройка автоматических уведомлений помогает в быстром устранении сбоев и деградации, не дожидаясь вмешательства оператора.

Интеграция Terraform с такими инструментами, как **Prometheus**, **Grafana**, **Datadog**, **CloudWatch** и другими, позволяет создавать эффективную систему мониторинга, оповещений и алёртов для масштабируемых и высоконагруженных инфраструктур.

### 2. **Интеграция Terraform с мониторингом**

Terraform позволяет автоматизировать создание и управление инфраструктурой, но также важно настраивать системы мониторинга для отслеживания состояния этой инфраструктуры. Рассмотрим несколько популярных инструментов для мониторинга и алёртинга, которые можно интегрировать с Terraform.

#### 2.1. **Интеграция с Prometheus и Grafana**

**Prometheus** — это система мониторинга и алёртинга с открытым исходным кодом, которая собирает и сохраняет метрики в виде временных рядов. **Grafana** используется для визуализации этих метрик.

Чтобы настроить интеграцию Terraform с Prometheus и Grafana, вам нужно создать необходимые ресурсы для этих инструментов в облаке или в локальной инфраструктуре.

Пример конфигурации Terraform для развертывания **Prometheus** и **Grafana** с использованием **Docker**:

```hcl
provider "docker" {}

resource "docker_network" "monitoring_network" {
  name = "monitoring_network"
}

# Prometheus container
resource "docker_container" "prometheus" {
  image = "prom/prometheus:latest"
  name  = "prometheus"
  ports {
    internal = 9090
    external = 9090
  }
  networks_advanced {
    name = docker_network.monitoring_network.name
  }
  volumes {
    host_path      = "./prometheus.yml"
    container_path = "/etc/prometheus/prometheus.yml"
  }
  restart = "unless-stopped"
}

# Grafana container
resource "docker_container" "grafana" {
  image = "grafana/grafana:latest"
  name  = "grafana"
  ports {
    internal = 3000
    external = 3000
  }
  networks_advanced {
    name = docker_network.monitoring_network.name
  }
  environment = {
    GF_SECURITY_ADMIN_PASSWORD = "admin"
  }
  restart = "unless-stopped"
}
```

**Конфигурация Prometheus** (`prometheus.yml`) для сбора метрик и интеграции с Grafana:

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
```

Этот пример создает два контейнера: один для **Prometheus** (с метриками), второй для **Grafana** (для визуализации). Вы также можете добавить контейнеры для других сервисов, которые вы хотите мониторить с помощью Prometheus.

#### 2.2. **Интеграция с Datadog**

**Datadog** — это облачный сервис мониторинга, который собирает метрики и логи с ваших приложений, серверов и облачных сервисов. Для интеграции Terraform с Datadog можно использовать официальный провайдер **Datadog** для Terraform, чтобы автоматически создавать необходимые ресурсы и конфигурировать мониторинг.

Пример Terraform-конфигурации для создания алёрта в **Datadog**:

```hcl
provider "datadog" {
  api_key = "your_api_key"
  app_key = "your_app_key"
}

resource "datadog_monitor" "high_cpu_usage" {
  name               = "High CPU Usage"
  type               = "metric alert"
  query              = "avg(last_5m):avg:system.cpu.idle{host:your_host} < 20"
  message            = "CPU usage is above 80%! Check immediately."
  escalation_message = "CPU usage has been high for 5 minutes."
  tags               = ["env:production", "team:ops"]
  notify_no_data     = false
  renotify_interval  = 10
  notify_audit       = true
}
```

Этот код создает алёрт для **CPU usage**, который уведомляет, когда процессорная нагрузка на хост превышает 80%. Этот алёрт будет автоматически настроен в Datadog с помощью Terraform.

#### 2.3. **Интеграция с AWS CloudWatch**

**AWS CloudWatch** — это сервис мониторинга, предоставляемый Amazon, который позволяет отслеживать состояние ресурсов в AWS и настроить алёрты.

Пример Terraform-конфигурации для настройки алёрта в **CloudWatch**:

```hcl
resource "aws_cloudwatch_metric_alarm" "cpu_utilization" {
  alarm_name          = "High CPU Utilization"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "CPUUtilization"
  namespace           = "AWS/EC2"
  period              = 300
  statistic           = "Average"
  threshold           = 80

  alarm_actions = [
    "arn:aws:sns:us-west-2:123456789012:MySNSTopic"
  ]
  dimensions = {
    InstanceId = "i-1234567890abcdef0"
  }
}
```

Этот пример создаёт алёрт в **AWS CloudWatch**, который уведомляет, если загрузка процессора на EC2-инстансе превышает 80% в течение 5 минут.

### 3. **Настройка алёртов и уведомлений**

Интеграция с мониторингом — это только половина работы. Важно правильно настроить алёрты, которые будут уведомлять вас о проблемах с инфраструктурой.

#### 3.1. **Типы алёртов**:

* **По меткам**: Настроить алёрты на основе меток, таких как загрузка процессора, использование памяти, или трафика.
* **По ошибкам**: Например, если контейнер перестает работать или происходит сбой в приложении.
* **По состоянию ресурса**: Если сервис недоступен или имеет ненормальное состояние.

#### 3.2. **Уведомления через разные каналы**:

* **Email**: Уведомления по электронной почте.
* **SMS**: Уведомления через мобильные сообщения.
* **Slack**: Уведомления в каналах Slack.
* **Webhook**: Уведомления через вебхуки, которые могут быть использованы для интеграции с другими инструментами.

Пример уведомлений через Slack с использованием Datadog:

```hcl
resource "datadog_integration_slack" "slack_integration" {
  channel = "#alerts"
  workspace = "your_slack_workspace_id"
}
```

#### 3.3. **Автоматические действия**:

* **Автоматическое восстановление**: Когда алёрт срабатывает, можно настроить автоматические действия для исправления проблемы, такие как перезапуск сервиса, пересоздание инстанса или масштабирование ресурсов.
* **Роллбеки**: При выявлении сбоя, можно автоматически вернуть инфраструктуру в исходное состояние, что снижает время простоя.

### Заключение

Интеграция Terraform с системами мониторинга и алёртинга помогает автоматически отслеживать состояние инфраструктуры, настраивать оповещения и предотвращать потенциальные проблемы. Использование таких инструментов, как **Prometheus**, **Grafana**, **Datadog**, **AWS CloudWatch** и других, позволяет эффективно управлять масштабируемыми и высоконагруженными системами. Автоматические уведомления и алёрты обеспечивают быстрые реакции на любые отклонения от нормы, что повышает стабильность и безопасность вашей инфраструктуры.
